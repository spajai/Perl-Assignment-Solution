use strict;
use warnings;

use FindBin;
use lib "$FindBin::Bin/../lib";

use Test::More;
use Test::Exception;
use Data::Dumper;

my $expected_country_hashref = {
    '127' => 'Niger',
    '32' => 'Cape Verde',
    '90' => 'South Korea',
    '206' => 'Norfolk Island',
    '118' => 'Morocco',
    '71' => 'Guyana',
    '102' => 'Macedonia',
    '16' => 'Belarus',
    '55' => 'Eritrea',
    '84' => 'Japan',
    '233' => 'Saint Helena',
    '259' => 'Aruba',
    '194' => 'Abkhazia',
    '57' => 'Ethiopia',
    '220' => 'Guernsey',
    '163' => 'Sudan',
    '89' => 'North Korea',
    '175' => 'Trinidad and Tobago',
    '31' => 'Canada',
    '35' => 'Chile',
    '11' => 'Azerbaijan',
    '208' => 'French Polynesia',
    '93' => 'Laos',
    '29' => 'Cambodia',
    '199' => 'Somaliland',
    '114' => 'Moldova',
    '226' => 'British Sovereign Base Areas',
    '58' => 'Fiji',
    '211' => 'Saint Martin',
    '153' => 'Seychelles',
    '15' => 'Barbados',
    '101' => 'Luxembourg',
    '73' => 'Honduras',
    '76' => 'India',
    '62' => 'Gambia',
    '67' => 'Grenada',
    '241' => 'Howland Island',
    '198' => 'Pridnestrovie (Transnistria)',
    '139' => 'Portugal',
    '129' => 'Norway',
    '236' => 'Northern Mariana Islands',
    '249' => 'Wake Island',
    '218' => 'Niue',
    '202' => 'Christmas Island',
    '168' => 'Syria',
    '184' => 'United States',
    '135' => 'Paraguay',
    '14' => 'Bangladesh',
    '145' => 'Saint Lucia',
    '49' => 'Dominica',
    '178' => 'Turkmenistan',
    '24' => 'Brazil',
    '140' => 'Qatar',
    '124' => 'Netherlands',
    '104' => 'Malawi',
    '131' => 'Pakistan',
    '181' => 'Ukraine',
    '234' => 'South Georgia & South Sandwich Islands',
    '154' => 'Sierra Leone',
    '23' => 'Botswana',
    '96' => 'Lesotho',
    '159' => 'Somalia',
    '160' => 'South Africa',
    '47' => 'Denmark',
    '8' => 'Armenia',
    '98' => 'Libya',
    '37' => 'Colombia',
    '43' => 'Croatia',
    '270' => 'Peter I Island',
    '195' => 'Taiwan',
    '5' => 'Angola',
    '21' => 'Bolivia',
    '193' => 'Zimbabwe',
    '119' => 'Mozambique',
    '180' => 'Uganda',
    '244' => 'Kingman Reef',
    '162' => 'Sri Lanka',
    '246' => 'Navassa Island',
    '240' => 'Guam',
    '74' => 'Hungary',
    '61' => 'Gabon',
    '230' => 'Gibraltar',
    '115' => 'Monaco',
    '103' => 'Madagascar',
    '201' => 'Ashmore and Cartier Islands',
    '113' => 'Micronesia',
    '152' => 'Serbia',
    '189' => 'Venezuela',
    '91' => 'Kuwait',
    '107' => 'Mali',
    '87' => 'Kenya',
    '174' => 'Tonga',
    '77' => 'Indonesia',
    '214' => 'French Southern and Antarctic Lands',
    '221' => 'Isle of Man',
    '39' => 'Congo',
    '64' => 'Germany',
    '97' => 'Liberia',
    '12' => 'Bahamas',
    '41' => 'Costa Rica',
    '52' => 'Egypt',
    '229' => 'Falkland Islands (Islas Malvinas)',
    '45' => 'Cyprus',
    '260' => 'Netherlands Antilles',
    '237' => 'Puerto Rico',
    '188' => 'Vatican City',
    '68' => 'Guatemala',
    '1' => 'Afghanistan',
    '136' => 'Peru',
    '116' => 'Mongolia',
    '144' => 'Saint Kitts and Nevis',
    '100' => 'Lithuania',
    '222' => 'Jersey',
    '25' => 'Brunei',
    '120' => 'Myanmar (Burma)',
    '83' => 'Jamaica',
    '254' => 'French Guiana',
    '177' => 'Turkey',
    '217' => 'Cook Islands',
    '239' => 'Baker Island',
    '122' => 'Nauru',
    '143' => 'Rwanda',
    '269' => 'Ross Dependency',
    '205' => 'Heard Island and McDonald Islands',
    '158' => 'Solomon Islands',
    '42' => 'Cote d\'Ivoire (Ivory Coast)',
    '22' => 'Bosnia and Herzegovina',
    '46' => 'Czech Republic',
    '235' => 'Turks and Caicos Islands',
    '6' => 'Antigua and Barbuda',
    '36' => 'China',
    '213' => 'Wallis and Futuna',
    '183' => 'United Kingdom',
    '94' => 'Latvia',
    '51' => 'Ecuador',
    '169' => 'Tajikistan',
    '132' => 'Palau',
    '171' => 'Thailand',
    '200' => 'South Ossetia',
    '18' => 'Belize',
    '125' => 'New Zealand',
    '44' => 'Cuba',
    '27' => 'Burkina Faso',
    '272' => 'British Antarctic Territory',
    '161' => 'Spain',
    '190' => 'Vietnam',
    '95' => 'Lebanon',
    '20' => 'Bhutan',
    '109' => 'Marshall Islands',
    '231' => 'Montserrat',
    '243' => 'Johnston Atoll',
    '151' => 'Senegal',
    '148' => 'San Marino',
    '78' => 'Iran',
    '106' => 'Maldives',
    '157' => 'Slovenia',
    '65' => 'Ghana',
    '197' => 'Northern Cyprus',
    '203' => 'Cocos (Keeling) Islands',
    '261' => 'Svalbard',
    '138' => 'Poland',
    '81' => 'Israel',
    '137' => 'Philippines',
    '60' => 'France',
    '86' => 'Kazakhstan',
    '247' => 'Palmyra Atoll',
    '204' => 'Coral Sea Islands',
    '165' => 'Swaziland',
    '17' => 'Belgium',
    '2' => 'Albania',
    '186' => 'Uzbekistan',
    '82' => 'Italy',
    '110' => 'Mauritania',
    '147' => 'Samoa',
    '228' => 'Cayman Islands',
    '268' => 'Australian Antarctic Territory',
    '69' => 'Guinea',
    '112' => 'Mexico',
    '172' => 'Timor-Leste (East Timor)',
    '191' => 'Yemen',
    '224' => 'Bermuda',
    '187' => 'Vanuatu',
    '223' => 'Anguilla',
    '262' => 'Ascension',
    '79' => 'Iraq',
    '121' => 'Namibia',
    '212' => 'Saint Pierre and Miquelon',
    '126' => 'Nicaragua',
    '238' => 'American Samoa',
    '251' => 'Macau',
    '253' => 'Greenland',
    '176' => 'Tunisia',
    '209' => 'Mayotte',
    '216' => 'Bouvet Island',
    '256' => 'Martinique',
    '117' => 'Montenegro',
    '170' => 'Tanzania',
    '33' => 'Central African Republic',
    '63' => 'Georgia',
    '7' => 'Argentina',
    '80' => 'Ireland',
    '26' => 'Bulgaria',
    '227' => 'British Virgin Islands',
    '99' => 'Liechtenstein',
    '72' => 'Haiti',
    '179' => 'Tuvalu',
    '255' => 'Guadeloupe',
    '182' => 'United Arab Emirates',
    '108' => 'Malta',
    '92' => 'Kyrgyzstan',
    '232' => 'Pitcairn Islands',
    '10' => 'Austria',
    '225' => 'British Indian Ocean Territory',
    '142' => 'Russia',
    '207' => 'New Caledonia',
    '263' => 'Tristan da Cunha',
    '167' => 'Switzerland',
    '48' => 'Djibouti',
    '133' => 'Panama',
    '123' => 'Nepal',
    '149' => 'Sao Tome and Principe',
    '50' => 'Dominican Republic',
    '210' => 'Saint Barthelemy',
    '258' => 'Aland',
    '173' => 'Togo',
    '56' => 'Estonia',
    '66' => 'Greece',
    '19' => 'Benin',
    '54' => 'Equatorial Guinea',
    '70' => 'Guinea-Bissau',
    '166' => 'Sweden',
    '88' => 'Kiribati',
    '30' => 'Cameroon',
    '141' => 'Romania',
    '128' => 'Nigeria',
    '252' => 'Faroe Islands',
    '28' => 'Burundi',
    '75' => 'Iceland',
    '40' => 'Democratic Republic of Congo',
    '134' => 'Papua New Guinea',
    '156' => 'Slovakia',
    '192' => 'Zambia',
    '250' => 'Hong Kong',
    '59' => 'Finland',
    '215' => 'Clipperton Island',
    '150' => 'Saudi Arabia',
    '271' => 'Queen Maud Land',
    '130' => 'Oman',
    '155' => 'Singapore',
    '53' => 'El Salvador',
    '245' => 'Midway Islands',
    '219' => 'Tokelau',
    '13' => 'Bahrain',
    '257' => 'Reunion',
    '105' => 'Malaysia',
    '85' => 'Jordan',
    '3' => 'Algeria',
    '185' => 'Uruguay',
    '248' => 'U.S. Virgin Islands',
    '111' => 'Mauritius',
    '9' => 'Australia',
    '146' => 'Saint Vincent and the Grenadines',
    '38' => 'Comoros',
    '4' => 'Andorra',
    '34' => 'Chad',
    '164' => 'Suriname',
    '196' => 'Nagorno-Karabakh',
    '242' => 'Jarvis Island'
  };

my $country_names_sorted_aref = [
          'Abkhazia',
          'Afghanistan',
          'Aland',
          'Albania',
          'Algeria',
          'American Samoa',
          'Andorra',
          'Angola',
          'Anguilla',
          'Antigua and Barbuda',
          'Argentina',
          'Armenia',
          'Aruba',
          'Ascension',
          'Ashmore and Cartier Islands',
          'Australia',
          'Australian Antarctic Territory',
          'Austria',
          'Azerbaijan',
          'Bahamas',
          'Bahrain',
          'Baker Island',
          'Bangladesh',
          'Barbados',
          'Belarus',
          'Belgium',
          'Belize',
          'Benin',
          'Bermuda',
          'Bhutan',
          'Bolivia',
          'Bosnia and Herzegovina',
          'Botswana',
          'Bouvet Island',
          'Brazil',
          'British Antarctic Territory',
          'British Indian Ocean Territory',
          'British Sovereign Base Areas',
          'British Virgin Islands',
          'Brunei',
          'Bulgaria',
          'Burkina Faso',
          'Burundi',
          'Cambodia',
          'Cameroon',
          'Canada',
          'Cape Verde',
          'Cayman Islands',
          'Central African Republic',
          'Chad',
          'Chile',
          'China',
          'Christmas Island',
          'Clipperton Island',
          'Cocos (Keeling) Islands',
          'Colombia',
          'Comoros',
          'Congo',
          'Cook Islands',
          'Coral Sea Islands',
          'Costa Rica',
          'Cote d\'Ivoire (Ivory Coast)',
          'Croatia',
          'Cuba',
          'Cyprus',
          'Czech Republic',
          'Democratic Republic of Congo',
          'Denmark',
          'Djibouti',
          'Dominica',
          'Dominican Republic',
          'Ecuador',
          'Egypt',
          'El Salvador',
          'Equatorial Guinea',
          'Eritrea',
          'Estonia',
          'Ethiopia',
          'Falkland Islands (Islas Malvinas)',
          'Faroe Islands',
          'Fiji',
          'Finland',
          'France',
          'French Guiana',
          'French Polynesia',
          'French Southern and Antarctic Lands',
          'Gabon',
          'Gambia',
          'Georgia',
          'Germany',
          'Ghana',
          'Gibraltar',
          'Greece',
          'Greenland',
          'Grenada',
          'Guadeloupe',
          'Guam',
          'Guatemala',
          'Guernsey',
          'Guinea',
          'Guinea-Bissau',
          'Guyana',
          'Haiti',
          'Heard Island and McDonald Islands',
          'Honduras',
          'Hong Kong',
          'Howland Island',
          'Hungary',
          'Iceland',
          'India',
          'Indonesia',
          'Iran',
          'Iraq',
          'Ireland',
          'Isle of Man',
          'Israel',
          'Italy',
          'Jamaica',
          'Japan',
          'Jarvis Island',
          'Jersey',
          'Johnston Atoll',
          'Jordan',
          'Kazakhstan',
          'Kenya',
          'Kingman Reef',
          'Kiribati',
          'Kuwait',
          'Kyrgyzstan',
          'Laos',
          'Latvia',
          'Lebanon',
          'Lesotho',
          'Liberia',
          'Libya',
          'Liechtenstein',
          'Lithuania',
          'Luxembourg',
          'Macau',
          'Macedonia',
          'Madagascar',
          'Malawi',
          'Malaysia',
          'Maldives',
          'Mali',
          'Malta',
          'Marshall Islands',
          'Martinique',
          'Mauritania',
          'Mauritius',
          'Mayotte',
          'Mexico',
          'Micronesia',
          'Midway Islands',
          'Moldova',
          'Monaco',
          'Mongolia',
          'Montenegro',
          'Montserrat',
          'Morocco',
          'Mozambique',
          'Myanmar (Burma)',
          'Nagorno-Karabakh',
          'Namibia',
          'Nauru',
          'Navassa Island',
          'Nepal',
          'Netherlands',
          'Netherlands Antilles',
          'New Caledonia',
          'New Zealand',
          'Nicaragua',
          'Niger',
          'Nigeria',
          'Niue',
          'Norfolk Island',
          'North Korea',
          'Northern Cyprus',
          'Northern Mariana Islands',
          'Norway',
          'Oman',
          'Pakistan',
          'Palau',
          'Palmyra Atoll',
          'Panama',
          'Papua New Guinea',
          'Paraguay',
          'Peru',
          'Peter I Island',
          'Philippines',
          'Pitcairn Islands',
          'Poland',
          'Portugal',
          'Pridnestrovie (Transnistria)',
          'Puerto Rico',
          'Qatar',
          'Queen Maud Land',
          'Reunion',
          'Romania',
          'Ross Dependency',
          'Russia',
          'Rwanda',
          'Saint Barthelemy',
          'Saint Helena',
          'Saint Kitts and Nevis',
          'Saint Lucia',
          'Saint Martin',
          'Saint Pierre and Miquelon',
          'Saint Vincent and the Grenadines',
          'Samoa',
          'San Marino',
          'Sao Tome and Principe',
          'Saudi Arabia',
          'Senegal',
          'Serbia',
          'Seychelles',
          'Sierra Leone',
          'Singapore',
          'Slovakia',
          'Slovenia',
          'Solomon Islands',
          'Somalia',
          'Somaliland',
          'South Africa',
          'South Georgia & South Sandwich Islands',
          'South Korea',
          'South Ossetia',
          'Spain',
          'Sri Lanka',
          'Sudan',
          'Suriname',
          'Svalbard',
          'Swaziland',
          'Sweden',
          'Switzerland',
          'Syria',
          'Taiwan',
          'Tajikistan',
          'Tanzania',
          'Thailand',
          'Timor-Leste (East Timor)',
          'Togo',
          'Tokelau',
          'Tonga',
          'Trinidad and Tobago',
          'Tristan da Cunha',
          'Tunisia',
          'Turkey',
          'Turkmenistan',
          'Turks and Caicos Islands',
          'Tuvalu',
          'U.S. Virgin Islands',
          'Uganda',
          'Ukraine',
          'United Arab Emirates',
          'United Kingdom',
          'United States',
          'Uruguay',
          'Uzbekistan',
          'Vanuatu',
          'Vatican City',
          'Venezuela',
          'Vietnam',
          'Wake Island',
          'Wallis and Futuna',
          'Yemen',
          'Zambia',
          'Zimbabwe'
        ];

use_ok('oDesk::DB');
use_ok('oDesk::Model::Country');

my $db = oDesk::DB->new;


#-------------------------------------------------------------------------------

# test that constructor requires file parameter
# if the file parameter is not passed, the following string should be
# in the exception: 'Attribute (file) is required at constructor'

{
  throws_ok { oDesk::Model::Country->new }
    qr/Attribute \(db\) is required at constructor/,
      'db is required parameter'; 
}

#-------------------------------------------------------------------------------

# test instantiation
{
  my $model = oDesk::Model::Country->new(db => $db);
  isa_ok($model, 'oDesk::Model::Country');

} 

#-------------------------------------------------------------------------------

{
  my $model = oDesk::Model::Country->new(db => $db);
  isa_ok($model, 'oDesk::Model::Country');
  
  my $href = $model->get_all_hashref;
  is_deeply($href, $expected_country_hashref, 'get_all_hashref');
}

#-------------------------------------------------------------------------------

{
  my $model = oDesk::Model::Country->new(db => $db);
  isa_ok($model, 'oDesk::Model::Country');
  
  my $aref = $model->get_country_names;
  ok(ref $aref eq 'ARRAY', 'arrayref returned in scalar context');
  is_deeply($aref, $country_names_sorted_aref, 'contents of arrayref are correct'); 

  my @array = $model->get_country_names;
  ok(@array == @{ $country_names_sorted_aref }, 'array returned has correct number of elements');
  is_deeply(\@array, $country_names_sorted_aref, 'contents of arrayref are correct'); 
}

#-------------------------------------------------------------------------------

{
  my $model = oDesk::Model::Country->new(db => $db);
  isa_ok($model, 'oDesk::Model::Country');

  for my $id (sort { $a <=> $b } keys %{ $expected_country_hashref } ) {
    my $expected_name = $expected_country_hashref->{$id};

    my $name = $model->get_name_for_id($id);

    cmp_ok($name, 'eq', $expected_name, "get_name_for_id - $id $name");

    my $found_id = $model->get_id_for_name($name);

    cmp_ok($found_id, '==', $id, "get_id_for_name - $id $name");
  }
}


done_testing();
